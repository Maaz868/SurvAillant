{% extends "header.html" %} 
{% block content %} 


  <div class="card" style="padding-left:250px; padding-top:100px">
    <div class="card-body" id="alertContainer">
      <!-- Alerts will be dynamically added here -->
    </div>
  </div>


  <script>

    var socket1 = new WebSocket("ws://" + window.location.host + "/ws/anomalyprediction/");
    var socket2 = new WebSocket("ws://" + window.location.host + "/ws/securityprediction/");

    socket1.onmessage = function (event) {
        var predictionInfo = JSON.parse(event.data);
        createAlert(predictionInfo, 'Anomaly');
  
    };

    socket2.onmessage = function (event) {
        var predictionInfo = JSON.parse(event.data);
        createAlert(predictionInfo, 'Security Threat');
  
    };

    // socket2.onmessage = function (event) {
    //     var predictionInfo = JSON.parse(event.data);
    //     if (predictionInfo.prediction === -1) {
    //         createAlert(predictionInfo.prediction);
    //     }
    // };

    // Function to create a new alert
    function createAlert(info, heading) {
      var alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-primary alert-dismissible fade show';
      alertDiv.role = 'alert';
      var dataInfo = info.data;
      console.log(dataInfo);
      alertDiv.innerHTML = `
            <h4 class="alert-heading clickable-heading">${heading} Detected !!!</h4>
            <p>Source IP: ${dataInfo[0]}</p>
            <p>Destination IP: ${dataInfo[1]}</p>
            <hr>
            <p class="mb-0">Anomaly Detected from ${dataInfo[0]} to ${dataInfo[1]}.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

      // Append the alert to the container
      var alertContainer = document.querySelector('.card-body');
      alertContainer.appendChild(alertDiv);

      // Show the 'No more Alerts' message if no alerts are present
      updateAlertsMessage();
      var clickableHeading = alertDiv.querySelector('.clickable-heading');
        clickableHeading.addEventListener('click', function () {
            if (heading.toLowerCase() === 'anomaly') {
                window.location.href = "{% url 'anomalyreports' %}"; // Redirect to anomalyreports
            } else if (heading.toLowerCase() === 'security threat') {
                window.location.href = "{% url 'securityreports' %}"; // Redirect to securityreports
            }
        });
    }

    // Function to check if there are no alerts and show the message accordingly
    function updateAlertsMessage() {
      var alertContainer = document.querySelector('.card-body');
      var noAlertsMessage = document.getElementById('noAlertsMessage');

      // If no alerts are present, display the message; otherwise, hide it
      if (alertContainer.children.length === 0) {
        noAlertsMessage.style.display = 'block';
      } else {
        noAlertsMessage.style.display = 'none';
      }
    }

    // Example: Create some alerts (You can replace this with data coming from backend)
    
    createAlert('Danger Heading');
    
    

    // Add event listener to dynamically created close buttons to update alerts message
    document.querySelector('.card-body').addEventListener('click', function(event) {
      if (event.target.classList.contains('btn-close')) {
        // Remove the parent alert when close button is clicked
        event.target.parentNode.remove();
        // Update the alerts message
        updateAlertsMessage();
      }
    });
  </script>
  
  {% endblock %}

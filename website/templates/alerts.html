{% extends "header.html" %} 
{% block content %} 


  <div class="card" style="padding-left:250px; padding-top:100px">
    <div class="card-body" id="alertContainer">
      <!-- Alerts will be dynamically added here -->
    </div>
  </div>


  <script>

    function getStoredAlerts() {
        return JSON.parse(localStorage.getItem('alertsall')) || [];
    }

    // Function to save alerts to localStorage
    function saveAlerts(alerts) {
        localStorage.setItem('alertsall', JSON.stringify(alerts));
    }

    // Function to add a new alert
    function addAlertToStorage(alertInfo) {
        var alerts = getStoredAlerts();
        alerts.push(alertInfo);
        saveAlerts(alerts);
    }


    window.onload = function() {
      // console.log("iderh", localStorage.getItem('alertsall'));

      var storedAlerts = JSON.parse(localStorage.getItem('alertsall')) || [];
      // var alerts = JSON.parse(localStorage.getItem('alertsall')) || [];
      
      // Get the length of the alerts array
      var alertCount = storedAlerts.length;
    
      // Update the badge with the number of alerts
      var badgeElement = document.getElementById('notifCount');
      badgeElement.textContent = alertCount;

      // var notif = document.getElementById('notif');
      // notif.textContent = alertCount;
    
      // Update the text displaying the number of alerts
      var alertCountTextElement = document.getElementById('alertCountText');
      alertCountTextElement.textContent = alertCount;
      // console.log(storedAlerts);
      // console.log(storedAlerts);
      // Loop through each stored alert and create alert elements
      console.log("Stored alerts length:", storedAlerts.length);
      storedAlerts.forEach(function(alertInfo, index) {
          console.log("Processing alert", index + 1);
          var info = {
              data: [alertInfo.sourceIP, alertInfo.destinationIP]
          };
          var heading = alertInfo.heading;
          createAlert(info, heading, true);
      });
      
    };
    

    var socket1 = new WebSocket("ws://" + window.location.host + "/ws/anomalyprediction/");
    var socket2 = new WebSocket("ws://" + window.location.host + "/ws/securityprediction/");

    socket1.onmessage = function (event) {
        var predictionInfo = JSON.parse(event.data);
        createAlert(predictionInfo, 'Anomaly', false);
    
    };

    socket2.onmessage = function (event) {
        var predictionInfo = JSON.parse(event.data);
        createAlert(predictionInfo, 'Security Threat', false);

    };

   



    function createAlert(info, heading, socket) {
      // var count = localStorage.getItem('aler');
      // count = count + 1;
      // localStorage.setItem('aler',count);
      // console.log(info.data);
      var alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-primary alert-dismissible fade show';
      alertDiv.role = 'alert';
      var dataInfo = info.data;
      console.log(dataInfo[0],dataInfo[1],heading);
      // console.log("type",typeof dataInfo);
      // console.log(dataInfo);
      alertDiv.innerHTML = `
            <h4 class="alert-heading clickable-heading">${heading} Detected !!!</h4>
            <p>Source IP: ${dataInfo[0]}</p>
            <p>Destination IP: ${dataInfo[1]}</p>
            <hr>
            <p class="mb-0">${heading} Detected from ${dataInfo[0]} to ${dataInfo[1]}.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        // console.log("hogaya4");
      // Append the alert to the container
      var alertContainer = document.querySelector('.card-body');
      alertContainer.appendChild(alertDiv);
      // console.log("hogaya3");

      if (socket == false){
        addAlertToStorage({
          heading: heading,
          sourceIP: dataInfo[0],
          destinationIP: dataInfo[1]
        });
        console.log('added');
      }
      // console.log("hogaya2");
      // Show the 'No more Alerts' message if no alerts are present
      // updateAlertsMessage();
      var clickableHeading = alertDiv.querySelector('.clickable-heading');
        clickableHeading.addEventListener('click', function () {
            if (heading.toLowerCase() === 'anomaly') {
                window.location.href = "{% url 'anomalyreports' %}"; // Redirect to anomalyreports
            } else if (heading.toLowerCase() === 'security threat') {
                window.location.href = "{% url 'securityreports' %}"; // Redirect to securityreports
            }
        });
        // console.log("hogaya");
      }

    


    

    // Function to check if there are no alerts and show the message accordingly
    function updateAlertsMessage() {
      var alertContainer = document.querySelector('.card-body');
      var noAlertsMessage = document.getElementById('noAlertsMessage');

      // If no alerts are present, display the message; otherwise, hide it
      if (alertContainer.children.length === 0) {
        noAlertsMessage.style.display = 'block';
      } else {
        noAlertsMessage.style.display = 'none';
      }
    }

    // Example: Create some alerts (You can replace this with data coming from backend)
    // console.log("iderh", localStorage.getItem('aler'));
    createAlert('Danger Heading');
    // console.log("iderh", localStorage.getItem('aler'));

    

    // Add event listener to dynamically created close buttons to update alerts message
    document.querySelector('.card-body').addEventListener('click', function(event) {
      if (event.target.classList.contains('btn-close')) {
        // Remove the parent alert when close button is clicked
        event.target.parentNode.remove();
        // Update the alerts message
        updateAlertsMessage();
        // saveAlertsToStorage();
      }
    });




  </script>
  
  
  {% endblock %}
